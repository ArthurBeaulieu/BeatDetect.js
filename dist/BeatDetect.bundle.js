!function(){"use strict";var e={};function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var r=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o(this,e),window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineContext=window.OfflineAudioContext||window.webkitOfflineAudioContext,window.AudioContext&&window.OfflineContext?(this.VERSION="1.0.0",this._log=t.log||!1,this._perf=t.perf||!1,this._sampleRate=t.sampleRate||44100,this._round=t.round||!1,this._float=t.float||8,this._lowPassFreq=t.lowPassFreq||150,this._highPassFreq=t.highPassFreq||100,this._bpmRange=t.bpmRange||[90,180],this._timeSignature=t.timeSignature||4,this.count=0,this._ts={current:0,previous:0,first:0},this._tapResetId=-1):console.error("BeatDetect.ERROR : Your browser doesn't support the WebAudio API.")}var r,i;return r=e,(i=[{key:"getBeatInfo",value:function(e){var t=this;return e.perf={m0:performance.now(),m1:0,m2:0,m3:0},new Promise((function(o,n){t._fetchRawTrack(e).then(t._buildOfflineCtx.bind(t)).then(t._processRenderedBuffer.bind(t)).then(o).catch(n)}))}},{key:"_fetchRawTrack",value:function(e){var o=this;return new Promise((function(n,r){if(e)if(e.url&&e.perf&&"string"==typeof e.url&&"object"===t(e.perf)){o._logEvent("log","Fetch track".concat(e.name?" "+e.name:"","."));var i=new XMLHttpRequest;i.open("GET",e.url,!0),i.responseType="arraybuffer",i.onload=function(){404==i.status&&r("BeatDetect.ERROR : 404 File not found."),e.perf.m1=performance.now(),n(Object.assign(i,e))},i.onerror=r,i.send()}else r("BeatDetect.ERROR : Options object sent to _fetchRawTrack method is invalid.");else r("BeatDetect.ERROR : No options object sent to _fetchRawTrack method.")}))}},{key:"_buildOfflineCtx",value:function(e){var o=this;return new Promise((function(n,r){e?e.response&&e.perf&&"object"===t(e.response)&&"object"===t(e.perf)?(o._logEvent("log","Offline rendering of the track."),(new AudioContext).decodeAudioData(e.response,(function(t){var i=new window.OfflineContext(2,t.duration*o._sampleRate,o._sampleRate),s=i.createBufferSource();s.buffer=t;var a=i.createBiquadFilter();a.type="lowpass",a.frequency.value=o._lowPassFreq,a.Q.value=1;var f=i.createBiquadFilter();f.type="highpass",f.frequency.value=o._highPassFreq,f.Q.value=1,s.connect(a),a.connect(f),f.connect(i.destination),s.start(0),i.startRendering(),i.oncomplete=function(t){e.perf.m2=performance.now(),n(Object.assign(t,e))},i.onerror=r}),(function(e){r("BeatDetect.ERROR : ".concat(e))}))):r("BeatDetect.ERROR : Options object sent to _buildOfflineCtx method is invalid."):r("BeatDetect.ERROR : No options object sent to _buildOfflineCtx method.")}))}},{key:"_processRenderedBuffer",value:function(e){var o=this;return new Promise((function(n,r){if(e)if(e.renderedBuffer&&e.perf&&"object"===t(e.renderedBuffer)&&"object"===t(e.perf)){o._logEvent("log","Collect beat info.");var i=e.renderedBuffer.getChannelData(0),s=e.renderedBuffer.getChannelData(1),a=o._getPeaks([i,s]),f=o._getIntervals(a).sort((function(e,t){return t.count-e.count})).splice(0,5),u=o._getOffsets(i,f[0].tempo);e.perf.m3=performance.now(),o._logEvent("log","Analysis done."),n(Object.assign({bpm:f[0].tempo,offset:o._floatRound(u.offset,o._float),firstBar:o._floatRound(u.firstBar,o._float)},o._perf?{perf:o._getPerfDuration(e.perf)}:null))}else r("BeatDetect.ERROR : Options object sent to _processRenderedBuffer method is invalid.");else r("BeatDetect.ERROR : No options object sent to _processRenderedBuffer method.")}))}},{key:"_getPeaks",value:function(e){for(var t=this._sampleRate/2,o=e[0].length/t,n=[],r=0;r<o;++r){for(var i=0,s=r*t;s<(r+1)*t;++s){var a=Math.max(Math.abs(e[0][s]),Math.abs(e[1][s]));(!i||a>i.volume)&&(i={position:s,volume:a})}n.push(i)}return n.sort((function(e,t){return t.volume-e.volume})),(n=n.splice(0,.5*n.length)).sort((function(e,t){return e.position-t.position})),n}},{key:"_getIntervals",value:function(e){var t=this,o=[];return e.forEach((function(n,r){for(var i=function(i){for(var s={tempo:60*t._sampleRate/(e[r+i].position-n.position),count:1,position:n.position,peaks:[]};s.tempo<=t._bpmRange[0];)s.tempo*=2;for(;s.tempo>t._bpmRange[1];)s.tempo/=2;!0===t._round?s.tempo=Math.round(s.tempo):s.tempo=t._floatRound(s.tempo,t._float),o.some((function(e){return e.tempo===s.tempo&&(e.peaks.push(n),++e.count,!0)}))||o.push(s)},s=1;r+s<e.length&&s<10;++s)i(s)})),o}},{key:"_getOffsets",value:function(e,t){for(var o=this._sampleRate/2,n=e.length/o,r=[],i=0;i<n;++i){for(var s=0,a=i*o;a<(i+1)*o;++a){var f=e[a];(!s||f>s.volume)&&(s={position:a-Math.round(60/t*.05*this._sampleRate),volume:f})}r.push(s)}var u=[].concat(r);r.sort((function(e,t){return t.volume-e.volume}));for(var c=this._getLowestTimeOffset(r[0].position,t),l=0,p=0,h=0;h<r.length;++h){var m=this._getLowestTimeOffset(r[h].position,t);(m-c<.05||c-m>-.05)&&(l+=m,++p)}for(var d=0;u[d].volume<.02;)++d;var _=u[d].position/this._sampleRate;return _>l/p&&_<60/t&&(_=l/p),{offset:l/p,firstBar:_}}},{key:"_getLowestTimeOffset",value:function(e,t){for(var o=60/t,n=e/this._sampleRate;n>=o;)n-=o*this._timeSignature;if(n<0)for(;n<0;)n+=o;return n}},{key:"_getPerfDuration",value:function(e){return{total:(e.m3-e.m0)/1e3,fetch:(e.m1-e.m0)/1e3,render:(e.m2-e.m1)/1e3,process:(e.m3-e.m2)/1e3}}},{key:"tapBpm",value:function(e){e.element.addEventListener("click",this._tapBpm.bind(this,e),!1)}},{key:"_tapBpm",value:function(e){var t=this;if(window.clearTimeout(this._tapResetId),this._ts.current=Date.now(),0===this._ts.first&&(this._ts.first=this._ts.current),0!==this._ts.previous){var o=6e4*this.count/(this._ts.current-this._ts.first);e.precision&&(o=this._floatRound(o,e.precision)),e.callback(o)}this._ts.previous=this._ts.current,++this.count,this._tapResetId=window.setTimeout((function(){t.count=0,t._ts.current=0,t._ts.previous=0,t._ts.first=0,e.callback("--")}),5e3)}},{key:"_logEvent",value:function(e,t){!0===this._log&&console[e]("BeatDetect : ".concat(t))}},{key:"_floatRound",value:function(e,t){var o=Math.pow(10,t||0);return Math.round(e*o)/o}},{key:"sampleRate",set:function(e){this._sampleRate=e}},{key:"log",set:function(e){this._log=e}},{key:"perf",set:function(e){this._perf=e}},{key:"round",set:function(e){this._round=e}},{key:"float",set:function(e){this._float=e}},{key:"lowPassFreq",set:function(e){this._lowPassFreq=e}},{key:"highPassFreq",set:function(e){this._highPassFreq=e}}])&&n(r.prototype,i),e}();e.default=r,window.BeatDetect=e.default}();