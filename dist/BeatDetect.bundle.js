window.BeatDetect=function(){"use strict";var e={812:function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineContext=window.OfflineAudioContext||window.webkitOfflineAudioContext,window.AudioContext&&window.OfflineContext?(this.VERSION="1.0.0",this._log=t.log||!1,this._perf=t.perf||!1,this._sampleRate=t.sampleRate||44100,this._round=t.round||!1,this._float=t.float||8,this._lowPassFreq=t.lowPassFreq||150,this._highPassFreq=t.highPassFreq||100,this._bpmRange=t.bpmRange||[90,180],this._timeSignature=t.timeSignature||4,this.count=0,this._ts={current:0,previous:0,first:0},this._tapResetId=-1):console.error("BeatDetect.ERROR : Your browser doesn't support the WebAudio API.")}var t,o;return t=e,(o=[{key:"getBeatInfo",value:function(e){var t=this;return e.perf={m0:performance.now(),m1:0,m2:0,m3:0},new Promise((function(n,o){t._fetchRawTrack(e).then(t._buildOfflineCtx.bind(t)).then(t._processRenderedBuffer.bind(t)).then(n).catch(o)}))}},{key:"_fetchRawTrack",value:function(e){return this._logEvent("log","Fetch track ".concat(e.name||"")),new Promise((function(t,n){var o=new XMLHttpRequest;o.open("GET",e.url,!0),o.responseType="arraybuffer",o.onload=function(){e.perf.m1=performance.now(),t(Object.assign(o,e))},o.onerror=n,o.send()}))}},{key:"_buildOfflineCtx",value:function(e){var t=this;return this._logEvent("log","Offline rendering of the track"),new Promise((function(n,o){(new AudioContext).decodeAudioData(e.response,(function(r){var i=new window.OfflineContext(2,r.duration*t._sampleRate,t._sampleRate),s=i.createBufferSource();s.buffer=r;var a=i.createBiquadFilter();a.type="lowpass",a.frequency.value=t._lowPassFreq,a.Q.value=1;var u=i.createBiquadFilter();u.type="highpass",u.frequency.value=t._highPassFreq,u.Q.value=1,s.connect(a),a.connect(u),u.connect(i.destination),s.start(0),i.startRendering(),i.oncomplete=function(t){e.perf.m2=performance.now(),n(Object.assign(t,e))},i.onerror=o}))}))}},{key:"_processRenderedBuffer",value:function(e){var t=this;return this._logEvent("log","Collect beat info"),new Promise((function(n){var o=e.renderedBuffer.getChannelData(0),r=e.renderedBuffer.getChannelData(1),i=t._getPeaks([o,r]),s=t._getIntervals(i).sort((function(e,t){return t.count-e.count})).splice(0,5),a=t._getOffsets(o,s[0].tempo);e.perf.m3=performance.now(),t._logEvent("log","Analysis done"),n(Object.assign({bpm:s[0].tempo,offset:t._floatRound(a.offset,t._float),firstBar:t._floatRound(a.firstBar,t._float)},t._perf?{perf:t._getPerfDuration(e.perf)}:null))}))}},{key:"_getPeaks",value:function(e){for(var t=this._sampleRate/2,n=e[0].length/t,o=[],r=0;r<n;++r){for(var i=0,s=r*t;s<(r+1)*t;++s){var a=Math.max(Math.abs(e[0][s]),Math.abs(e[1][s]));(!i||a>i.volume)&&(i={position:s,volume:a})}o.push(i)}return o.sort((function(e,t){return t.volume-e.volume})),(o=o.splice(0,.5*o.length)).sort((function(e,t){return e.position-t.position})),o}},{key:"_getIntervals",value:function(e){var t=this,n=[];return e.forEach((function(o,r){for(var i=function(i){for(var s={tempo:60*t._sampleRate/(e[r+i].position-o.position),count:1,position:o.position,peaks:[]};s.tempo<=t._bpmRange[0];)s.tempo*=2;for(;s.tempo>t._bpmRange[1];)s.tempo/=2;!0===t._round?s.tempo=Math.round(s.tempo):s.tempo=t._floatRound(s.tempo,t._float),n.some((function(e){return e.tempo===s.tempo&&(e.peaks.push(o),++e.count,!0)}))||n.push(s)},s=1;r+s<e.length&&s<10;++s)i(s)})),n}},{key:"_getOffsets",value:function(e,t){for(var n=this._sampleRate/2,o=e.length/n,r=[],i=0;i<o;++i){for(var s=0,a=i*n;a<(i+1)*n;++a){var u=e[a];(!s||u>s.volume)&&(s={position:a-Math.round(60/t*.05*this._sampleRate),volume:u})}r.push(s)}var f=[].concat(r);r.sort((function(e,t){return t.volume-e.volume}));for(var l=this._getLowestTimeOffset(r[0].position,t),c=0,p=0,h=0;h<r.length;++h){var m=this._getLowestTimeOffset(r[h].position,t);(m-l<.05||l-m>-.05)&&(c+=m,++p)}for(var _=0;f[_].volume<.02;)++_;var v=f[_].position/this._sampleRate;return v>c/p&&v<60/t&&(v=c/p),{offset:c/p,firstBar:v}}},{key:"_getLowestTimeOffset",value:function(e,t){for(var n=60/t,o=e/this._sampleRate;o>=n;)o-=n*this._timeSignature;if(o<0)for(;o<0;)o+=n;return o}},{key:"_getPerfDuration",value:function(e){return{total:(e.m3-e.m0)/1e3,fetch:(e.m1-e.m0)/1e3,render:(e.m2-e.m1)/1e3,process:(e.m3-e.m2)/1e3}}},{key:"tapBpm",value:function(e){e.element.addEventListener("click",this._tapBpm.bind(this,e),!1)}},{key:"_tapBpm",value:function(e){var t=this;if(window.clearTimeout(this._tapResetId),this._ts.current=Date.now(),0===this._ts.first&&(this._ts.first=this._ts.current),0!==this._ts.previous){var n=6e4*this.count/(this._ts.current-this._ts.first);e.precision&&(n=this._floatRound(n,e.precision)),e.callback(n)}this._ts.previous=this._ts.current,++this.count,this._tapResetId=window.setTimeout((function(){t.count=0,t._ts.current=0,t._ts.previous=0,t._ts.first=0,e.callback("--")}),5e3)}},{key:"_logEvent",value:function(e,t){!0===this._log&&console[e]("BeatDetect : ".concat(t))}},{key:"_floatRound",value:function(e,t){var n=Math.pow(10,t||0);return Math.round(e*n)/n}},{key:"sampleRate",set:function(e){this._sampleRate=e}},{key:"log",set:function(e){this._log=e}},{key:"perf",set:function(e){this._perf=e}},{key:"round",set:function(e){this._round=e}},{key:"float",set:function(e){this._float=e}},{key:"lowPassFreq",set:function(e){this._lowPassFreq=e}},{key:"highPassFreq",set:function(e){this._highPassFreq=e}}])&&n(t.prototype,o),e}();t.default=o}},t={};return function n(o){if(t[o])return t[o].exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}(812)}().default;