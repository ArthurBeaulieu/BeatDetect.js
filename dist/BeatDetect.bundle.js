window.BeatDetect=function(){"use strict";var e={812:function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineContext=window.OfflineAudioContext||window.webkitOfflineAudioContext,this._sampleRate=t.sampleRate||44100,this._log=t.log||!1,this._perf=t.perf||!1,this._round=t.round||!1,this._float=t.float||8,this._lowPassFreq=t.lowPassFreq||150,this._highPassFreq=t.highPassFreq||100,this._bpmRange=t.bpmRange||[90,180],this._timeSignature=t.timeSignature||4}var t,o;return t=e,(o=[{key:"getBeatInfo",value:function(e){var t=this;return e.perf={m0:performance.now(),m1:0,m2:0,m3:0},new Promise((function(n,o){t._fetchRawTrack(e).then(t._buildOfflineCtx.bind(t)).then(t._processRenderedBuffer.bind(t)).then(n).catch(o)}))}},{key:"_fetchRawTrack",value:function(e){return this._logEvent("log","Fetch track ".concat(e.name||"")),new Promise((function(t,n){var o=new XMLHttpRequest;o.open("GET",e.url,!0),o.responseType="arraybuffer",o.onload=function(){e.perf.m1=performance.now(),t(Object.assign(o,e))},o.onerror=n,o.send()}))}},{key:"_buildOfflineCtx",value:function(e){var t=this;return this._logEvent("log","Offline rendering of the track"),new Promise((function(n,o){(new AudioContext).decodeAudioData(e.response,(function(r){var a=new window.OfflineContext(2,r.duration*t._sampleRate,t._sampleRate),i=a.createBufferSource();i.buffer=r;var s=a.createBiquadFilter();s.type="lowpass",s.frequency.value=t._lowPassFreq,s.Q.value=1;var f=a.createBiquadFilter();f.type="highpass",f.frequency.value=t._highPassFreq,f.Q.value=1,i.connect(s),s.connect(f),f.connect(a.destination),i.start(0),a.startRendering(),a.oncomplete=function(t){e.perf.m2=performance.now(),n(Object.assign(t,e))},a.onerror=o}))}))}},{key:"_processRenderedBuffer",value:function(e){var t=this;return this._logEvent("log","Collect beat info"),new Promise((function(n){var o=e.renderedBuffer.getChannelData(0),r=e.renderedBuffer.getChannelData(1),a=t._getPeaks([o,r]),i=t._getIntervals(a).sort((function(e,t){return t.count-e.count})).splice(0,5),s=t._getOffsets(o,o.length,i[0].tempo);e.perf.m3=performance.now(),t._logEvent("log","Analysis done"),n(Object.assign({bpm:i[0].tempo,offset:t._floatRound(s.offset,t._float),firstBar:t._floatRound(s.firstBar,t._float)},t._perf?{perf:t._getPerfDuration(e.perf)}:null))}))}},{key:"_getPeaks",value:function(e){for(var t=this._sampleRate/2,n=e[0].length/t,o=[],r=0;r<n;++r){for(var a=0,i=r*t;i<(r+1)*t;++i){var s=Math.max(Math.abs(e[0][i]),Math.abs(e[1][i]));(!a||s>a.volume)&&(a={position:i,volume:s})}o.push(a)}return o.sort((function(e,t){return t.volume-e.volume})),(o=o.splice(0,.5*o.length)).sort((function(e,t){return e.position-t.position})),o}},{key:"_getIntervals",value:function(e){var t=this,n=[];return e.forEach((function(o,r){for(var a=function(a){for(var i={tempo:60*t._sampleRate/(e[r+a].position-o.position),count:1,position:o.position,peaks:[]};i.tempo<=t._bpmRange[0];)i.tempo*=2;for(;i.tempo>t._bpmRange[1];)i.tempo/=2;!0===t._round?i.tempo=Math.round(i.tempo):i.tempo=t._floatRound(i.tempo,t._float),n.some((function(e){return e.tempo===i.tempo&&(e.peaks.push(o),++e.count,!0)}))||n.push(i)},i=1;r+i<e.length&&i<10;++i)a(i)})),n}},{key:"_getOffsets",value:function(e,t,n){for(var o=this._sampleRate/2,r=e.length/o,a=[],i=0;i<r;++i){for(var s=0,f=i*o;f<(i+1)*o;++f){var u=e[f];(!s||u>s.volume)&&(s={position:f-Math.round(60/n*.05*this._sampleRate),volume:u})}a.push(s)}var l=[].concat(a);a.sort((function(e,t){return t.volume-e.volume}));for(var c=this._getLowestTimeOffset(a[0].position,t,n),p=0,h=0,m=0;m<a.length;++m){var v=this._getLowestTimeOffset(a[m].position,t,n);(v-c<.05||c-v>-.05)&&(p+=v,++h)}for(var _=0;l[_].volume<.02;)++_;var d=l[_].position/this._sampleRate;return d>p/h&&d<60/n&&(d=p/h),{offset:p/h,firstBar:d}}},{key:"_getLowestTimeOffset",value:function(e,t,n){for(var o=60/n,r=e/this._sampleRate;r>=o;)r-=o*this._timeSignature;if(r<0)for(;r<0;)r+=o;return r}},{key:"_getPerfDuration",value:function(e){return{total:(e.m3-e.m0)/1e3,fetch:(e.m1-e.m0)/1e3,render:(e.m2-e.m1)/1e3,process:(e.m3-e.m2)/1e3}}},{key:"_logEvent",value:function(e,t){!0===this._log&&console[e]("BeatDetect : ".concat(t))}},{key:"_floatRound",value:function(e,t){var n=Math.pow(10,t||0);return Math.round(e*n)/n}},{key:"sampleRate",set:function(e){this._sampleRate=e}},{key:"log",set:function(e){this._log=e}},{key:"perf",set:function(e){this._perf=e}},{key:"round",set:function(e){this._round=e}},{key:"float",set:function(e){this._float=e}},{key:"lowPassFreq",set:function(e){this._lowPassFreq=e}},{key:"highPassFreq",set:function(e){this._highPassFreq=e}}])&&n(t.prototype,o),e}();t.default=o}},t={};return function n(o){if(t[o])return t[o].exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}(812)}().default;